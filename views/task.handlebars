<!-- NAV BAR -->
{{> navbar_partial}}
<!-- NAV BAR -->

<br />
<!--Hide The Add Subtask Form if user is not owner -->
{{#if project.is_owner}}
  <!-- ADD A SUBTASK -->
  <div class="container">
    <h2>Add a New Subtask to this Task</h2>
    <form id="add_Subtask" action="/task" method="post">

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="Project_Name">Subtask Name</label>
          <input required type="text" class="form-control" placeholder="Subtask Name" name="name">
        </div>


        <div class="form-group col-md-2">
          <label for="Due_Date">Due Date</label>
          <br />
          <input required class="form-control" type="date" id="due_date" width="144" placeholder="Due Date" name="due_date" />
        </div>

      </div>


      <div class="form-row">
        <div class="form-group col-sm-2">
          <label for="status">Status</label>
          <select required class="custom-select mr-sm-2" id="status" name="status">
            <option selected value="">Status...</option>
            <option value="To Do">To Do</option>
            <option value="In Progress">In Progress</option>
            <option value="On Hold">On Hold</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
        <div class="form-group col-md-6">
          <label for="user">Assignee</label>
          <!-- Can be re-used for tasks / subtasks forms -->
          <select class="custom-select mr-sm-2" id="user" name="user" required>
            <option selected value="">Assignee...</option>
            {{#each users}}
            <option value={{this.id}}>{{this.name}} - {{this.email}}</option>
            {{/each}}
          </select>
        </div> 
        <div class="form-group col-md-8">
          <label for="description">Task Description</label>
          <textarea required maxlength="500" class="form-control" placeholder="Subtask Description" name="description"></textarea> 
        </div>
      </div>
      <input id="project_id" name="project_id" type="hidden" value="{{project_id}}">
      <input id="task_id" name="task_id" type="hidden" value="{{task_id}}">
      <button type="submit" value="Submit" class="btn btn-primary">Submit</button>
    </form>
  </div>
{{/if}}


<!-- DISPLAY SUBTASKS -->
<p></p>
<div class="container">
    <div class="row justify-content-between">
    <div class="col-4">
      <h2>Subtasks for This Task</h2>
    </div>
    <div class="float-right">
      <a href="/project/{{project_id}}"> 
        <button type="button" class="btn btn-success" float->
          Return to Project
        </button>
      </a>
    </div>
  </div>
  <p></p>
  <table class="table table-striped mb-0">
    <thead class="thead-dark">
      <tr>
        <th scope="col">Project Name: {{project.Project_Name}}</th>
        <th class="text-right" scope="col">Project Owner: {{project.name}}</th>
      </tr>
    </thead>
  </table>
  <table class="table table-striped mb-0">
    <thead class="thead-dark">
      <tr>
        <th scope="col">Project Due Date: {{project.Due_Date}}</th>
        <th class="text-right" scope="col">Project Status: {{project.Status}}</th>
      </tr>
    </thead>
  </table>
    <table class="table split table-striped mb-0">
    <thead class="thead-dark">
      <tr>
        <th scope="col">Task Name: {{task.name}}</th>
        <th class="text-right" scope="col">Task Assignee: {{task.assignee_name}}</th>
      </tr>
    </thead>
  </table>
  <table class="table table-striped mb-0">
    <thead class="thead-dark">
      <tr>
        <th scope="col">Task Due Date: {{task.due_date}}</th>
        <th class="text-right" scope="col">Task Status: {{task.status}}</th>
      </tr>
    </thead>
  </table>
  <table class="table table-striped mb-0">
    <thead class="thead-dark">
      <tr>
        <th scope="col">Task Description: {{task.description}}</th>
      </tr>
    </thead>
  </table>
  <table class="table split table-striped">

    <thead class="thead-dark">
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Name</th>
        <th scope="col">Description</th>
        <th scope="col">Due Date</th>
        <th scope="col">Status</th>
        <th scope="col">Assignee</th>
        <th scope="col">Manage</th>
      </tr>
    </thead>

    <tbody>
      {{#each subtasks}}
      <tr>
        <th scope="row">{{id}}</th>
        <td>{{name}}</td>
        <td>{{description}}</td>
        <td {{#if isOverdue}} class="danger"{{/if}}>{{due_date}}</td>
        <td>{{status}}</td>
        <td>{{assignee_name}}</td>
        <td>
          <!--Hide The Edit Button if user is not owner -->
          {{#ifCond is_owner '||' is_assignee}}
            <button class="btn btn-primary" data-toggle="modal" data-target=".bs-modal-sm2-{{id}}">
              <i class="fa fa-edit"></i>
            </button>
          {{/ifCond}}
          <!--Hide The Delete Button if user is not owner -->
          {{#if is_owner}}
            <button type="button" class="btn btn-danger" onclick="deleteSubtask({{id}})">
              <i class="fa fa-trash"></i>
            </button>
          {{/if}}
          <div class="modal fade bs-modal-sm2-{{id}}">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Edit Subtask {{name}}</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                  </div>
                  {{#if is_owner}}
                  <div class="modal-body">
                    <form method="post" action="/task/update"> 
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label for="subtask_name">Subtask Name</label>
                          <input required type="text" class="form-control" placeholder="Subtask Name" name="name" value="{{name}}" />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="due_date">Due Date</label>
                          <br />
                          <input required class="form-control" type="date" placeholder="Due Date" name="due_date" value="{{format_date}}" />
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group col-sm-4">
                          <label for="status">Status</label>
                          <select required class="custom-select mr-sm-2" name="status">
                            <option {{#ifCond status '==' 'To Do'}}selected{{/ifCond}} value="To Do">To Do</option>
                            <option {{#ifCond status '==' 'In Progress'}}selected{{/ifCond}} value="In Progress">In Progress</option>
                            <option {{#ifCond status '==' 'On Hold'}}selected{{/ifCond}} value="On Hold">On Hold</option>
                            <option {{#ifCond status '==' 'Completed'}}selected{{/ifCond}} value="Completed">Completed</option>
                          </select>
                        </div>
                        <div class="form-group col-md-8">
                          <label for="user">Assignee</label>
                          <select class="custom-select mr-sm-2" id="user" name="user" required>
                            {{#each ../../users}}
                            <option {{#ifCond this.id '===' ../assignee_id}}selected{{/ifCond}} value={{this.id}}>{{this.name}} - {{this.email}}</option>
                            {{/each}}
                          </select>
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group col-sm-12">
                          <textarea required maxlength="500" class="form-control" placeholder="Subtask Description" name="description">{{description}}</textarea> 
                          <input name="id" type="hidden" value="{{id}}" />
                        </div>
                      </div>
                    </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                    </form>
                  </div>
                </div><!-- /.modal-content -->
              {{else}}<!-- if is assignee -->
                <div class="modal-body">
                  <form method="post" action="/task/update-status"> 
                  <div class="form-row">
                        <div class="form-group col-sm-4">
                          <label for="status">Status</label>
                          <select required class="custom-select mr-sm-2" name="status">
                            <option {{#ifCond status '==' 'To Do'}}selected{{/ifCond}} value="To Do">To Do</option>
                            <option {{#ifCond status '==' 'In Progress'}}selected{{/ifCond}} value="In Progress">In Progress</option>
                            <option {{#ifCond status '==' 'On Hold'}}selected{{/ifCond}} value="On Hold">On Hold</option>
                            <option {{#ifCond status '==' 'Completed'}}selected{{/ifCond}} value="Completed">Completed</option>
                          </select>
                        </div>
                        <input name="id" type="hidden" value="{{id}}" />
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                  </form>
                </div><!-- /.modal-content -->
              {{/if}}
            </div><!-- /.modal-dialog -->
          </div><!-- /.modal -->
        </td>
      </tr>
      {{/each}}
    </tbody>

  </table>
</div>
<!-- DISPLAY SUBTASKS -->
